<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NetBrain Network Query</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        * { box-sizing: border-box; }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            margin: 0;
            min-height: 100vh;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            background-attachment: fixed;
            color: #e8e8e8;
            display: flex;
            flex-direction: column;
        }

        header {
            padding: 1rem 1.5rem;
            background: rgba(31, 31, 51, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(139, 180, 250, 0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        header span {
            background: linear-gradient(135deg, #89b4fa 0%, #cba6f7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            font-size: 1.25rem;
            letter-spacing: -0.02em;
        }

        header a {
            color: #89b4fa;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: all 0.2s;
            font-weight: 500;
        }

        header a:hover {
            background: rgba(137, 180, 250, 0.1);
            transform: translateY(-1px);
        }

        #app-main { display: flex; flex: 1; min-height: 0; }

        #sidebar {
            width: 280px;
            flex-shrink: 0;
            background: rgba(24, 24, 37, 0.6);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(139, 180, 250, 0.15);
            overflow-y: auto;
        }

        #chat-main {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
        }

        #messages {
            flex: 1;
            overflow: auto;
            padding: 2rem 1rem;
            max-width: 840px;
            margin: 0 auto;
            width: 100%;
        }

        .msg {
            margin-bottom: 1.5rem;
            padding: 1rem 1.25rem;
            border-radius: 12px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .msg.user {
            background: linear-gradient(135deg, rgba(137, 180, 250, 0.15) 0%, rgba(203, 166, 247, 0.15) 100%);
            border: 1px solid rgba(137, 180, 250, 0.3);
            margin-left: 3rem;
            box-shadow: 0 4px 6px -1px rgba(137, 180, 250, 0.1);
        }

        .msg.assistant {
            background: rgba(49, 50, 68, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(69, 71, 90, 0.5);
            margin-right: 3rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
        }

        .msg.assistant pre {
            white-space: pre-wrap;
            word-break: break-word;
            font-size: 0.9rem;
            background: rgba(30, 30, 46, 0.5);
            padding: 1rem;
            border-radius: 8px;
            border-left: 3px solid #89b4fa;
        }

        .table-with-controls { overflow-x: auto; margin: 1rem 0; }

        .msg.assistant table {
            width: 100%;
            min-width: 720px;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.9rem;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            background: rgba(30, 30, 46, 0.5);
            border: 1px solid rgba(137, 180, 250, 0.15);
        }

        .msg.assistant th, .msg.assistant td {
            border-bottom: 1px solid rgba(69, 71, 90, 0.3);
            padding: 0.875rem 1rem;
            text-align: left;
            white-space: nowrap;
        }

        .msg.assistant th {
            background: rgba(137, 180, 250, 0.12);
            font-weight: 600;
            color: #89b4fa;
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.08em;
            border-bottom: 2px solid rgba(137, 180, 250, 0.25);
        }

        .msg.assistant tbody tr {
            transition: all 0.2s ease;
        }

        .msg.assistant tbody tr:nth-child(even) {
            background: rgba(49, 50, 68, 0.2);
        }

        .msg.assistant tbody tr:hover {
            background: rgba(137, 180, 250, 0.15);
            transform: scale(1.001);
        }

        .msg.assistant tbody tr:last-child td {
            border-bottom: none;
        }

        .msg.assistant td {
            color: #cdd6f4;
            font-size: 0.9rem;
        }

        .msg.err { color: #f38ba8; }

        #form {
            padding: 1.5rem;
            background: rgba(31, 31, 51, 0.8);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(139, 180, 250, 0.2);
        }

        #form form {
            max-width: 840px;
            margin: 0 auto;
            display: flex;
            gap: 0.75rem;
        }

        #form input {
            flex: 1;
            padding: 0.875rem 1.25rem;
            border: 2px solid rgba(137, 180, 250, 0.3);
            border-radius: 12px;
            background: rgba(30, 30, 46, 0.6);
            color: #e8e8e8;
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        #form input:focus {
            outline: none;
            border-color: #89b4fa;
            box-shadow: 0 0 0 3px rgba(137, 180, 250, 0.1);
        }

        #form button {
            padding: 0.875rem 2rem;
            background: linear-gradient(135deg, #89b4fa 0%, #cba6f7 100%);
            color: #1e1e2e;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(137, 180, 250, 0.3);
        }

        #form button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 12px -2px rgba(137, 180, 250, 0.4);
        }

        #form button:active {
            transform: translateY(0);
        }

        .summary-heading {
            font-weight: 600;
            margin: 1.5rem 0 0.75rem 0;
            color: #89b4fa;
            font-size: 1.1rem;
        }

        .table-toolbar {
            margin-bottom: 0.75rem;
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .table-toolbar input {
            padding: 0.5rem 0.875rem;
            border: 1px solid rgba(137, 180, 250, 0.3);
            border-radius: 8px;
            background: rgba(30, 30, 46, 0.6);
            color: #e8e8e8;
            min-width: 180px;
            transition: border-color 0.2s;
        }

        .table-toolbar input:focus {
            outline: none;
            border-color: #89b4fa;
        }

        .table-toolbar button.export-csv {
            padding: 0.5rem 1rem;
            background: rgba(137, 180, 250, 0.15);
            color: #89b4fa;
            border: 1px solid rgba(137, 180, 250, 0.3);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .table-toolbar button.export-csv:hover {
            background: rgba(137, 180, 250, 0.25);
            transform: translateY(-1px);
        }

        .table-pagination {
            margin-top: 0.75rem;
            font-size: 0.85rem;
            color: #a6adc8;
        }

        .table-pagination button {
            padding: 0.375rem 0.875rem;
            margin-right: 0.5rem;
            background: rgba(137, 180, 250, 0.15);
            color: #89b4fa;
            border: 1px solid rgba(137, 180, 250, 0.3);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .table-pagination button:hover {
            background: rgba(137, 180, 250, 0.25);
        }

        .msg.assistant table.vertical-key-value-table {
            width: auto;
            min-width: 400px;
            max-width: 650px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .msg.assistant table.vertical-key-value-table th {
            text-align: left;
            padding: 0.875rem 2rem 0.875rem 1rem;
            color: #89b4fa;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.08em;
            vertical-align: middle;
            background: rgba(137, 180, 250, 0.08);
            width: 40%;
        }

        .msg.assistant table.vertical-key-value-table td {
            padding: 0.875rem 1rem;
            color: #e8e8e8;
            font-size: 0.95rem;
            font-weight: 500;
            vertical-align: middle;
        }

        .msg.assistant table.vertical-key-value-table tbody tr {
            border-bottom: 1px solid rgba(69, 71, 90, 0.25);
            transition: all 0.2s ease;
        }

        .msg.assistant table.vertical-key-value-table tbody tr:hover {
            background: rgba(137, 180, 250, 0.08);
        }

        .msg.assistant table.vertical-key-value-table tbody tr:last-child {
            border-bottom: none;
        }

        /* Path visualization - NetBrain style */
        .path-visual {
            margin: 1.5rem 0;
            padding: 2rem;
            background: rgba(24, 24, 37, 0.4);
            border-radius: 12px;
            border: 1px solid rgba(137, 180, 250, 0.15);
            overflow-x: auto;
            overflow-y: hidden;
        }

        .path-visual .path-status {
            margin-bottom: 1.5rem;
            color: #a6e3a1;
            font-size: 1.05rem;
            font-weight: 600;
            padding: 0.75rem 1rem;
            background: rgba(166, 227, 161, 0.1);
            border-left: 3px solid #a6e3a1;
            border-radius: 4px;
        }

        .path-visual .path-status.failed {
            color: #f38ba8;
            background: rgba(243, 139, 168, 0.1);
            border-left-color: #f38ba8;
        }

        .path-visual-row-wrap {
            position: relative;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 2rem 0;
        }

        .path-horizontal {
            position: relative;
            display: flex;
            flex-wrap: nowrap;
            align-items: center;
            justify-content: flex-start;
            gap: 3rem;
            min-height: 140px;
            width: max-content;
            padding: 0 1rem;
        }

        .path-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
            padding: 1.25rem;
            background: rgba(30, 30, 46, 0.6);
            border-radius: 8px;
            border: 1px solid rgba(137, 180, 250, 0.2);
            flex-shrink: 0;
            min-width: 140px;
            max-width: 200px;
            position: relative;
            z-index: 1;
            transition: all 0.2s ease;
        }

        .path-item:hover {
            background: rgba(49, 50, 68, 0.8);
            border-color: rgba(137, 180, 250, 0.4);
            transform: translateY(-2px);
        }

        .path-connectors-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .path-badge {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            z-index: 2;
        }

        .path-badge.source {
            background: #f9a825;
            color: #1e1e2e;
        }

        .path-badge.dest {
            background: #50fa7b;
            color: #1e1e2e;
        }

        .path-icon-wrap {
            width: 64px;
            height: 64px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(69, 71, 90, 0.3);
            border-radius: 8px;
            border: 1px solid rgba(137, 180, 250, 0.15);
        }

        .path-icon-wrap img {
            width: 56px;
            height: 56px;
            object-fit: contain;
        }

        .path-icon-fallback {
            width: 64px;
            height: 64px;
            border-radius: 8px;
            background: rgba(69, 71, 90, 0.3);
            color: #89b4fa;
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(137, 180, 250, 0.15);
        }

        .path-node-body {
            width: 100%;
            text-align: center;
        }
        .path-device-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: #cdd6f4;
            margin-bottom: 0.375rem;
            word-wrap: break-word;
        }
        .path-ip {
            font-size: 0.85rem;
            color: #89b4fa;
            margin-bottom: 0.25rem;
        }
        .path-interfaces {
            font-size: 0.8rem;
            color: #a6adc8;
            line-height: 1.4;
        }
        .path-zones {
            font-size: 0.75rem;
            color: #cba6f7;
            margin-top: 0.5rem;
            line-height: 1.4;
        }

        /* Sidebar styling */
        #example-queries { padding: 1.5rem; }

        #example-queries h2 {
            font-size: 0.75rem;
            font-weight: 700;
            color: #89b4fa;
            margin: 0 0 1rem 0;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .example-category { margin-bottom: 1.5rem; }
        .example-category:last-child { margin-bottom: 0; }

        .example-category-label {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #cba6f7;
            margin-bottom: 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid rgba(203, 166, 247, 0.2);
        }

        .example-chips { display: flex; flex-direction: column; gap: 0.5rem; }

        .example-chip {
            width: 100%;
            min-height: 2.5rem;
            padding: 0.625rem 0.875rem;
            background: rgba(49, 50, 68, 0.4);
            border: 1px solid rgba(137, 180, 250, 0.2);
            border-radius: 8px;
            color: #e8e8e8;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            line-height: 1.4;
        }

        .example-chip:hover {
            background: rgba(137, 180, 250, 0.15);
            border-color: #89b4fa;
            transform: translateX(4px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        /* Loading status */
        .status-msg {
            background: rgba(137, 180, 250, 0.1);
            border: 1px solid rgba(137, 180, 250, 0.3);
            color: #89b4fa;
            text-align: center;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(30, 30, 46, 0.3);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(137, 180, 250, 0.3);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(137, 180, 250, 0.5);
        }
    </style>
</head>
<body>
    <header>
        <span>‚ö° NetBrain Network Query</span>
        <a href="/logout">Sign out ‚Üí</a>
    </header>
    <div id="app-main">
        <aside id="sidebar">
            <div id="example-queries">
                <h2>üìã Example Queries</h2>
                <div class="example-category">
                    <div class="example-category-label">üåê NetBrain</div>
                    <div class="example-chips">
                        <button type="button" class="example-chip" data-query="Find path from 10.0.0.1 to 10.0.1.1">Find path from 10.0.0.1 to 10.0.1.1</button>
                        <button type="button" class="example-chip" data-query="Show network path from 192.168.1.1 to 192.168.2.1">Show network path from 192.168.1.1 to 192.168.2.1</button>
                        <button type="button" class="example-chip" data-query="Is path allowed from 10.0.0.1 to 10.0.1.1?">Is path allowed from 10.0.0.1 to 10.0.1.1?</button>
                        <button type="button" class="example-chip" data-query="Check if traffic from 10.0.0.1 to 10.0.1.1 on TCP 443 is allowed">Check if traffic from 10.0.0.1 to 10.0.1.1 on TCP 443 is allowed</button>
                        <button type="button" class="example-chip" data-query="What is the path between 11.0.0.1 and 11.0.0.250?">What is the path between 11.0.0.1 and 11.0.0.250?</button>
                    </div>
                </div>
                <div class="example-category">
                    <div class="example-category-label">üîß NetBox</div>
                    <div class="example-chips">
                        <button type="button" class="example-chip" data-query="Where is leander-dc-border-leaf1 racked?">Where is leander-dc-border-leaf1 racked?</button>
                        <button type="button" class="example-chip" data-query="Rack A4">Rack A4</button>
                        <button type="button" class="example-chip" data-query="List racks at Leander">List racks at Leander</button>
                    </div>
                </div>
                <div class="example-category">
                    <div class="example-category-label">üî• Panorama</div>
                    <div class="example-chips">
                        <button type="button" class="example-chip" data-query="What address group is 11.0.0.1 part of?">What address group is 11.0.0.1 part of?</button>
                        <button type="button" class="example-chip" data-query="What IPs are in address group leander_web?">What IPs are in address group leander_web?</button>
                    </div>
                </div>
                <div class="example-category">
                    <div class="example-category-label">üìä Splunk</div>
                    <div class="example-chips">
                        <button type="button" class="example-chip" data-query="Recent deny events for 10.0.0.250">Recent deny events for 10.0.0.250</button>
                    </div>
                </div>
            </div>
        </aside>
        <div id="chat-main">
            <div id="messages"></div>
            <div id="form">
                <form onsubmit="return send(event)">
                    <input id="input" type="text" placeholder="Ask about paths, devices, racks, Panorama, Splunk..." autocomplete="off">
                    <button type="submit" id="sendBtn">Send ‚Üí</button>
                </form>
            </div>
        </div>
    </div>
    <script>
        const messagesEl = document.getElementById('messages');
        const inputEl = document.getElementById('input');
        const sendBtn = document.getElementById('sendBtn');
        const exampleQueriesEl = document.getElementById('example-queries');
        let conversationHistory = [];

        document.querySelectorAll('.example-chip').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var q = this.getAttribute('data-query');
                if (q) { inputEl.value = q; inputEl.focus(); }
            });
        });

        function deviceTypeToIcon(deviceType) {
            if (!deviceType || typeof deviceType !== 'string') return null;
            var t = deviceType.toLowerCase().trim();
            if (t.indexOf('palo alto') !== -1 || (t.indexOf('firewall') !== -1 && t.indexOf('palo') !== -1)) return '/icons/paloalto_firewall.png';
            if (t.indexOf('arista') !== -1 || t.indexOf('switch') !== -1) return '/icons/arista_switch.png';
            if (t.indexOf('firewall') !== -1) return '/icons/paloalto_firewall.png';
            return null;
        }
        function deviceTypeToFallbackLabel(deviceType) {
            if (!deviceType || typeof deviceType !== 'string') return '?';
            var t = deviceType.toLowerCase().trim();
            if (t.indexOf('firewall') !== -1) return 'FW';
            if (t.indexOf('switch') !== -1 || t.indexOf('arista') !== -1) return 'SW';
            if (t.indexOf('hub') !== -1) return 'HUB';
            return '?';
        }
        function appendPathIconOrFallback(parent, deviceType) {
            var wrap = document.createElement('div');
            wrap.className = 'path-icon-wrap';
            var iconSrc = deviceTypeToIcon(deviceType);
            var fallbackLabel = deviceTypeToFallbackLabel(deviceType);
            if (iconSrc) {
                var img = document.createElement('img');
                img.className = 'path-icon';
                img.src = iconSrc;
                img.alt = deviceType || '';
                var fallback = document.createElement('span');
                fallback.className = 'path-icon-fallback';
                fallback.textContent = fallbackLabel;
                fallback.style.display = 'none';
                wrap.appendChild(img);
                wrap.appendChild(fallback);
                img.onerror = function() { img.style.display = 'none'; fallback.style.display = 'inline-flex'; };
            } else {
                var fb = document.createElement('span');
                fb.className = 'path-icon-fallback';
                fb.textContent = fallbackLabel;
                wrap.appendChild(fb);
            }
            parent.appendChild(wrap);
        }

        function normalizeInterface(s) {
            if (s == null || s === '') return '';
            s = String(s).trim();
            if (/^ethernet/i.test(s)) return 'Ethernet' + s.slice(8);
            if (/^eth/i.test(s)) return 'Ethernet' + s.slice(3);
            return s.charAt(0).toUpperCase() + s.slice(1);
        }
        function renderPathWithIcons(container, content) {
            var hops = content.path_hops;
            if (!hops || !hops.length) return;
            var wrap = document.createElement('div');
            wrap.className = 'path-visual';
            if (content.path_status || content.path_status_description || content.path_failure_reason) {
                var statusEl = document.createElement('p');
                statusEl.className = 'path-status';
                var statusText = content.path_status_description || content.path_status || '';
                if (content.path_failure_reason) statusText += (statusText ? ' ' : '') + content.path_failure_reason;
                if ((content.path_status || '').toLowerCase() === 'failed') statusEl.classList.add('failed');
                if ((content.status || '').toLowerCase() === 'denied') statusEl.classList.add('failed');
                statusEl.textContent = statusText || ('Path: ' + (content.source || '') + ' ‚Üí ' + (content.destination || ''));
                wrap.appendChild(statusEl);
            }
            if ((content.status === 'denied' || (content.path_status || '').toLowerCase() === 'failed') && (content.firewall_denied_by || content.policy_details)) {
                var denyBlock = document.createElement('div');
                denyBlock.className = 'path-deny-details';
                denyBlock.style.marginTop = '0.5rem';
                denyBlock.style.fontSize = '0.9rem';
                if (content.firewall_denied_by) {
                    var fwLine = document.createElement('p');
                    fwLine.style.margin = '0.2rem 0';
                    fwLine.style.color = '#f38ba8';
                    fwLine.textContent = 'Denied by firewall: ' + content.firewall_denied_by;
                    denyBlock.appendChild(fwLine);
                }
                if (content.policy_details) {
                    var polLine = document.createElement('p');
                    polLine.style.margin = '0.2rem 0';
                    polLine.style.color = '#a6adc8';
                    polLine.textContent = 'Policy: ' + content.policy_details;
                    denyBlock.appendChild(polLine);
                }
                wrap.appendChild(denyBlock);
            }
            var rowWrap = document.createElement('div');
            rowWrap.className = 'path-visual-row-wrap';
            var row = document.createElement('div');
            row.className = 'path-horizontal';
            var sourceIp = content.source || '';
            var destIp = content.destination || '';

            var nodes = [];
            var h0 = hops[0];
            console.log('DEBUG: First hop:', h0);
            nodes.push({ name: h0.from_device, type: h0.from_device_type, in: null, out: h0.out_interface, isSource: true, in_zone: null, out_zone: h0.out_zone, dg: h0.device_group });

            // Filter out hops with null to_device and duplicate hops (malformed API data)
            var validHops = [];
            var seenDevices = new Set([h0.from_device]);
            for (var i = 0; i < hops.length; i++) {
                console.log('DEBUG: Hop ' + i + ':', hops[i]);
                // Skip if to_device is null or already seen (duplicate)
                if (hops[i].to_device && !seenDevices.has(hops[i].to_device)) {
                    validHops.push(hops[i]);
                    seenDevices.add(hops[i].to_device);
                }
            }

            for (var i = 0; i < validHops.length; i++) {
                var hop = validHops[i];
                var inInt = hop.in_interface;
                var outInt = hop.out_interface;
                nodes.push({
                    name: hop.to_device,
                    type: hop.to_device_type,
                    in: inInt,
                    out: outInt,
                    isDest: i === validHops.length - 1,
                    in_zone: hop.in_zone,
                    out_zone: hop.out_zone,
                    dg: hop.device_group
                });
            }
            console.log('DEBUG: Valid hops:', validHops);
            console.log('DEBUG: All nodes:', nodes);

            for (var n = 0; n < nodes.length; n++) {
                var node = nodes[n];
                var inInt = node.in != null ? normalizeInterface(node.in) : '';
                var outInt = node.out != null ? normalizeInterface(node.out) : '';
                var item = document.createElement('div');
                item.className = 'path-item';
                if (node.isSource) {
                    var badgeA = document.createElement('span');
                    badgeA.className = 'path-badge source';
                    badgeA.textContent = 'A';
                    item.appendChild(badgeA);
                } else if (node.isDest) {
                    var badgeB = document.createElement('span');
                    badgeB.className = 'path-badge dest';
                    badgeB.textContent = 'B';
                    item.appendChild(badgeB);
                }
                appendPathIconOrFallback(item, node.type);
                var body = document.createElement('div');
                body.className = 'path-node-body';
                var nameEl = document.createElement('div');
                nameEl.className = 'path-device-name';
                var displayName = (node.name && node.name !== 'Unknown') ? node.name : null;
                if (!displayName && node.isDest && destIp) displayName = destIp;
                if (!displayName && node.isSource && sourceIp) displayName = sourceIp;
                nameEl.textContent = displayName || 'Device';
                body.appendChild(nameEl);
                if (node.isSource && sourceIp) {
                    var ipEl = document.createElement('div');
                    ipEl.className = 'path-ip';
                    ipEl.textContent = sourceIp;
                    body.appendChild(ipEl);
                }
                if (node.isDest && destIp) {
                    var ipEl2 = document.createElement('div');
                    ipEl2.className = 'path-ip';
                    ipEl2.textContent = destIp;
                    body.appendChild(ipEl2);
                }
                var intParts = [];
                if (inInt) intParts.push('In: ' + inInt);
                if (outInt) intParts.push('Out: ' + outInt);
                if (intParts.length) {
                    var intEl = document.createElement('div');
                    intEl.className = 'path-interfaces';
                    intEl.textContent = intParts.join(' | ');
                    body.appendChild(intEl);
                }
                var typeStr = (node.type || '').toLowerCase();
                var isFirewall = typeStr.indexOf('firewall') !== -1 || typeStr.indexOf('fw') !== -1 || typeStr.indexOf('palo') !== -1;
                if (isFirewall && (node.in_zone || node.out_zone || node.dg)) {
                    var zParts = [];
                    if (node.in_zone) zParts.push('In: ' + node.in_zone);
                    if (node.out_zone) zParts.push('Out: ' + node.out_zone);
                    if (node.dg) zParts.push('DG: ' + node.dg);
                    if (zParts.length) {
                        var zEl = document.createElement('div');
                        zEl.className = 'path-zones';
                        zEl.textContent = zParts.join(' | ');
                        body.appendChild(zEl);
                    }
                }
                item.appendChild(body);
                row.appendChild(item);
            }
            var svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('class', 'path-connectors-svg');
            svg.setAttribute('aria-hidden', 'true');
            row.insertBefore(svg, row.firstChild);
            rowWrap.appendChild(row);
            wrap.appendChild(rowWrap);

            // Add firewall details table if there are any firewalls in the path
            var firewalls = nodes.filter(function(node) {
                var typeStr = (node.type || '').toLowerCase();
                return typeStr.indexOf('firewall') !== -1 || typeStr.indexOf('fw') !== -1 || typeStr.indexOf('palo') !== -1;
            });

            if (firewalls.length > 0) {
                var fwSection = document.createElement('div');
                fwSection.style.marginTop = '2rem';
                fwSection.style.padding = '1.5rem';
                fwSection.style.background = 'rgba(30, 30, 46, 0.4)';
                fwSection.style.borderRadius = '8px';
                fwSection.style.border = '1px solid rgba(137, 180, 250, 0.15)';
                fwSection.style.overflowX = 'auto';
                fwSection.style.overflowY = 'hidden';

                var fwTitle = document.createElement('h4');
                fwTitle.textContent = 'Firewall Details';
                fwTitle.style.margin = '0 0 1rem 0';
                fwTitle.style.color = '#cba6f7';
                fwTitle.style.fontSize = '1rem';
                fwTitle.style.fontWeight = '600';
                fwSection.appendChild(fwTitle);

                var fwTable = document.createElement('table');
                fwTable.style.width = '100%';
                fwTable.style.borderCollapse = 'separate';
                fwTable.style.borderSpacing = '0';
                fwTable.style.fontSize = '0.9rem';
                fwTable.style.borderRadius = '8px';
                fwTable.style.overflow = 'hidden';
                fwTable.style.background = 'rgba(30, 30, 46, 0.5)';

                var thead = document.createElement('thead');
                var headerRow = document.createElement('tr');
                ['Device', 'In Interface', 'Out Interface', 'In Zone', 'Out Zone', 'Device Group'].forEach(function(text) {
                    var th = document.createElement('th');
                    th.textContent = text;
                    th.style.textAlign = 'left';
                    th.style.padding = '0.875rem 1rem';
                    th.style.borderBottom = '2px solid rgba(137, 180, 250, 0.25)';
                    th.style.background = 'rgba(137, 180, 250, 0.12)';
                    th.style.color = '#89b4fa';
                    th.style.fontWeight = '600';
                    th.style.textTransform = 'uppercase';
                    th.style.fontSize = '0.7rem';
                    th.style.letterSpacing = '0.08em';
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);
                fwTable.appendChild(thead);

                var tbody = document.createElement('tbody');
                firewalls.forEach(function(fw, idx) {
                    var row = document.createElement('tr');
                    row.style.borderBottom = '1px solid rgba(69, 71, 90, 0.3)';
                    row.style.transition = 'all 0.2s ease';
                    if (idx % 2 === 0) row.style.background = 'rgba(49, 50, 68, 0.2)';

                    // Add hover effect
                    row.addEventListener('mouseenter', function() {
                        this.style.background = 'rgba(137, 180, 250, 0.15)';
                    });
                    row.addEventListener('mouseleave', function() {
                        this.style.background = idx % 2 === 0 ? 'rgba(49, 50, 68, 0.2)' : 'transparent';
                    });

                    [fw.name || 'Unknown',
                     fw.in || '‚Äî',
                     fw.out || '‚Äî',
                     fw.in_zone || '‚Äî',
                     fw.out_zone || '‚Äî',
                     fw.dg || '‚Äî'].forEach(function(value) {
                        var td = document.createElement('td');
                        td.textContent = value;
                        td.style.padding = '0.875rem 1rem';
                        td.style.color = '#cdd6f4';
                        td.style.fontSize = '0.9rem';
                        row.appendChild(td);
                    });

                    // Remove border from last row
                    if (idx === firewalls.length - 1) {
                        row.style.borderBottom = 'none';
                    }

                    tbody.appendChild(row);
                });
                fwTable.appendChild(tbody);
                fwSection.appendChild(fwTable);
                wrap.appendChild(fwSection);
            }

            container.appendChild(wrap);
            requestAnimationFrame(function() { drawPathConnectors(rowWrap); });
            if (typeof ResizeObserver !== 'undefined') {
                var ro = new ResizeObserver(function() { drawPathConnectors(rowWrap); });
                ro.observe(rowWrap);
            }
        }

        function drawPathConnectors(rowWrap) {
            var row = rowWrap.querySelector('.path-horizontal');
            var items = row ? row.querySelectorAll('.path-item') : [];
            var svg = row ? row.querySelector('.path-connectors-svg') : null;
            if (!row || !svg || items.length < 2) return;

            var w = row.offsetWidth;
            var h = row.offsetHeight;
            svg.setAttribute('width', w);
            svg.setAttribute('height', h);
            svg.setAttribute('viewBox', '0 0 ' + w + ' ' + h);
            svg.innerHTML = '';

            // Add arrow marker definition
            var defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            var marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
            marker.setAttribute('id', 'arrowhead');
            marker.setAttribute('markerWidth', '10');
            marker.setAttribute('markerHeight', '10');
            marker.setAttribute('refX', '9');
            marker.setAttribute('refY', '3');
            marker.setAttribute('orient', 'auto');
            var polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            polygon.setAttribute('points', '0 0, 10 3, 0 6');
            polygon.setAttribute('fill', '#89b4fa');
            marker.appendChild(polygon);
            defs.appendChild(marker);
            svg.appendChild(defs);

            // Draw connection lines between devices
            for (var i = 0; i < items.length - 1; i++) {
                var a = items[i];
                var b = items[i + 1];
                var x1 = a.offsetLeft + a.offsetWidth;
                var y1 = a.offsetTop + a.offsetHeight / 2;
                var x2 = b.offsetLeft;
                var y2 = b.offsetTop + b.offsetHeight / 2;

                // Draw straight line with arrow
                var line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', x1);
                line.setAttribute('y1', y1);
                line.setAttribute('x2', x2);
                line.setAttribute('y2', y2);
                line.setAttribute('stroke', '#89b4fa');
                line.setAttribute('stroke-width', '2.5');
                line.setAttribute('stroke-linecap', 'round');
                line.setAttribute('marker-end', 'url(#arrowhead)');
                line.style.opacity = '0.8';
                svg.appendChild(line);
            }
        }

        function cellText(val) {
            if (val == null) return '';
            if (typeof val === 'string' && val.trim().charAt(0) === '{') {
                try {
                    var obj = JSON.parse(val);
                    if (obj && typeof obj === 'object') {
                        var name = (obj.intfDisplaySchemaObj && obj.intfDisplaySchemaObj.value) || obj.PhysicalInftName || obj.name || obj.value;
                        if (name != null) return String(name);
                    }
                } catch (e) {}
            }
            if (Array.isArray(val)) {
                if (val.length === 0) return '‚Äî';
                if (val.every(function(x) { return x == null || typeof x !== 'object'; }))
                    return val.map(function(x) { return x == null ? '' : String(x); }).join(', ');
                return val.map(function(item) {
                    if (item == null) return '';
                    if (typeof item !== 'object') return String(item);
                    if (item.name != null && item.value != null) return item.name + ' (' + item.value + ')';
                    if (item.name != null) return item.name;
                    var parts = [];
                    for (var k in item) if (Object.prototype.hasOwnProperty.call(item, k) && item[k] != null && typeof item[k] !== 'object') parts.push(item[k]);
                    return parts.length ? parts.join(', ') : JSON.stringify(item);
                }).join('; ');
            }
            if (typeof val === 'object') {
                var keys = Object.keys(val).filter(function(k) { return val[k] != null && typeof val[k] !== 'object'; });
                if (keys.length <= 3) return keys.map(function(k) { return val[k]; }).join(', ');
                return keys.slice(0, 3).map(function(k) { return k + ': ' + val[k]; }).join('; ');
            }
            return String(val);
        }

        function isArrayOfObjects(val) {
            return Array.isArray(val) && val.length > 0 && val.every(function(x) { return x != null && typeof x === 'object' && !Array.isArray(x); });
        }
        var PANORAMA_COLUMN_ORDER = {
            address_objects: ["name", "type", "value", "location", "device_group"],
            address_groups: ["name", "contains_address_object", "members", "location", "device_group"],
            members: ["name", "type", "value", "location", "device_group"],
            policies: ["name", "type", "rulebase", "action", "source", "destination", "services", "address_groups", "address_objects", "location", "device_group"]
        };
        var PANORAMA_TABLE_LABELS = { address_objects: "Address objects", address_groups: "Address groups", members: "Address group members (IPs)", policies: "Policy details" };
        var DEVICE_RACK_KEYS = ['device', 'rack', 'position', 'face', 'site', 'status', 'device_type'];
        function isDeviceRackRow(row) {
            if (!row || typeof row !== 'object') return false;
            var has = 0;
            for (var i = 0; i < DEVICE_RACK_KEYS.length; i++) if (Object.prototype.hasOwnProperty.call(row, DEVICE_RACK_KEYS[i])) has++;
            return has >= 4;
        }
        function verticalTableFromRow(row, preferredKeys) {
            var keys = preferredKeys && preferredKeys.length
                ? preferredKeys.filter(function(k) { return Object.prototype.hasOwnProperty.call(row, k); }).concat(Object.keys(row).filter(function(k) { return preferredKeys.indexOf(k) === -1 && k.indexOf('_debug') !== 0 && k.indexOf('ai_analysis') !== 0; }))
                : Object.keys(row).filter(function(k) { return k.indexOf('_debug') !== 0 && k.indexOf('ai_analysis') !== 0; });
            var table = document.createElement('table');
            table.className = 'vertical-key-value-table';
            var tbody = document.createElement('tbody');
            keys.forEach(function(k) {
                var tr = document.createElement('tr');
                var th = document.createElement('th');
                th.textContent = k.replace(/_/g, ' ');
                var td = document.createElement('td');
                td.textContent = cellText(row[k]);
                tr.appendChild(th);
                tr.appendChild(td);
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            return table;
        }
        function tableFromRows(rows, preferredKeys) {
            if (!rows.length) return null;
            var first = rows[0];
            var keys = preferredKeys && preferredKeys.length
                ? preferredKeys.filter(function(k) { return Object.prototype.hasOwnProperty.call(first, k); }).concat(Object.keys(first).filter(function(k) { return preferredKeys.indexOf(k) === -1; }))
                : Object.keys(first);
            var table = document.createElement('table');
            var thead = document.createElement('thead');
            var headRow = document.createElement('tr');
            keys.forEach(function(k) { var th = document.createElement('th'); th.textContent = k.replace(/_/g, ' '); headRow.appendChild(th); });
            thead.appendChild(headRow);
            table.appendChild(thead);
            var tbody = document.createElement('tbody');
            rows.forEach(function(row) {
                var tr = document.createElement('tr');
                keys.forEach(function(k) { var td = document.createElement('td'); td.textContent = cellText(row[k]); tr.appendChild(td); });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            return table;
        }
        function wrapTableWithPaginationAndFilter(table) {
            var tbody = table.querySelector('tbody');
            if (!tbody) return table;
            var rows = Array.from(tbody.querySelectorAll('tr'));
            if (rows.length === 0) return table;
            var wrap = document.createElement('div');
            wrap.className = 'table-with-controls';
            var toolbar = document.createElement('div');
            toolbar.className = 'table-toolbar';
            var filterInput = document.createElement('input');
            filterInput.type = 'text';
            filterInput.placeholder = 'Filter table...';
            toolbar.appendChild(filterInput);
            var exportBtn = document.createElement('button');
            exportBtn.type = 'button';
            exportBtn.className = 'export-csv';
            exportBtn.textContent = 'Export CSV';
            toolbar.appendChild(exportBtn);
            var paginationDiv = document.createElement('div');
            paginationDiv.className = 'table-pagination';
            var infoSpan = document.createElement('span');
            var prevBtn = document.createElement('button');
            prevBtn.textContent = 'Previous';
            var nextBtn = document.createElement('button');
            nextBtn.textContent = 'Next';
            var pageSize = 10;
            var currentPage = 1;
            function updateDisplay() {
                var filterVal = (filterInput.value || '').toLowerCase().trim();
                var filtered = filterVal ? rows.filter(function(tr) { return tr.textContent.toLowerCase().includes(filterVal); }) : rows;
                var total = filtered.length;
                var totalPages = Math.max(1, Math.ceil(total / pageSize));
                currentPage = Math.min(Math.max(1, currentPage), totalPages);
                var start = (currentPage - 1) * pageSize;
                var end = Math.min(start + pageSize, total);
                rows.forEach(function(tr) { tr.style.display = 'none'; });
                filtered.slice(start, end).forEach(function(tr) { tr.style.display = ''; });
                infoSpan.textContent = total === 0 ? 'No rows' : total <= pageSize && !filterVal ? 'Showing all ' + total : 'Showing ' + (start + 1) + '‚Äì' + end + ' of ' + total;
                prevBtn.disabled = currentPage <= 1;
                nextBtn.disabled = currentPage >= totalPages;
            }
            filterInput.addEventListener('input', function() { currentPage = 1; updateDisplay(); });
            prevBtn.addEventListener('click', function() { currentPage--; updateDisplay(); });
            nextBtn.addEventListener('click', function() { currentPage++; updateDisplay(); });
            exportBtn.addEventListener('click', function() {
                var thead = table.querySelector('thead');
                var tbody = table.querySelector('tbody');
                if (!thead || !tbody) return;
                var headerCells = thead.querySelectorAll('th');
                var headers = Array.from(headerCells).map(function(th) { return th.textContent.trim(); });
                function escapeCsv(val) {
                    var s = String(val == null ? '' : val).trim();
                    if (/[,\r\n"]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
                    return s;
                }
                var lines = [ headers.map(escapeCsv).join(',') ];
                Array.from(tbody.querySelectorAll('tr')).forEach(function(tr) {
                    var cells = tr.querySelectorAll('td');
                    var row = Array.from(cells).map(function(td) { return escapeCsv(td.textContent); });
                    if (row.length) lines.push(row.join(','));
                });
                var csv = lines.join('\r\n');
                var blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = 'export.csv';
                a.click();
                URL.revokeObjectURL(url);
            });
            var tableParent = table.parentNode;
            var tableNext = table.nextSibling;
            wrap.appendChild(toolbar);
            wrap.appendChild(table);
            paginationDiv.appendChild(infoSpan);
            paginationDiv.appendChild(prevBtn);
            paginationDiv.appendChild(nextBtn);
            wrap.appendChild(paginationDiv);
            updateDisplay();
            if (tableParent) tableParent.insertBefore(wrap, tableNext);
            return wrap;
        }

        function tryAppendObjectAsTables(container, data) {
            if (data == null || typeof data !== 'object') return false;
            if (Array.isArray(data) && isArrayOfObjects(data)) {
                if (data.length === 1 && isDeviceRackRow(data[0])) {
                    var vTable = verticalTableFromRow(data[0], DEVICE_RACK_KEYS);
                    if (vTable) { container.appendChild(vTable); return true; }
                }
                var table = tableFromRows(data);
                if (table) { container.appendChild(table); wrapTableWithPaginationAndFilter(table); return true; }
            }
            if (!Array.isArray(data) && isDeviceRackRow(data)) {
                var vTable = verticalTableFromRow(data, DEVICE_RACK_KEYS);
                if (vTable) { container.appendChild(vTable); return true; }
            }
            var arrayKeys = Object.keys(data).filter(function(k) {
                var v = data[k];
                return Array.isArray(v) && v.length > 0 && v.every(function(x) { return x != null && typeof x === 'object' && !Array.isArray(x); });
            });
            var flatKeys = Object.keys(data).filter(function(k) {
                if (arrayKeys.indexOf(k) >= 0 || k === 'ai_analysis') return false;
                var v = data[k];
                return v != null && typeof v !== 'object' && (typeof v !== 'string' || v.length <= 500);
            });
            if (arrayKeys.length > 0 || flatKeys.length > 0) {
                var showFlat = flatKeys.length > 0 && flatKeys.length <= 25;
                if (showFlat && arrayKeys.length > 0) {
                    var flatLower = flatKeys.map(function(k) { return k.toLowerCase(); });
                    var hasRack = flatLower.indexOf('site') >= 0 || flatLower.indexOf('facility') >= 0 || (arrayKeys.indexOf('devices') >= 0 && flatLower.some(function(k) { return k === 'name' || k === 'rack_name'; }));
                    var looksPanorama = (flatLower.indexOf('ip_address') >= 0 || flatLower.indexOf('vsys') >= 0) && (arrayKeys.indexOf('address_objects') >= 0 || arrayKeys.indexOf('address_groups') >= 0);
                    if (!hasRack || looksPanorama) showFlat = false;
                }
                if (showFlat) {
                    if (arrayKeys.length > 0) {
                        var title = document.createElement('p');
                        title.className = 'summary-heading';
                        title.textContent = 'Rack details';
                        container.appendChild(title);
                    }
                    var flatTable = tableFromRows([Object.fromEntries(flatKeys.map(function(k) { return [k, data[k]]; }))]);
                    if (flatTable) { container.appendChild(flatTable); wrapTableWithPaginationAndFilter(flatTable); }
                }
                var isPanorama = arrayKeys.indexOf('address_objects') >= 0 || arrayKeys.indexOf('address_groups') >= 0 || arrayKeys.indexOf('policies') >= 0 || arrayKeys.indexOf('members') >= 0;
                var tableOrder = isPanorama ? ['members', 'address_objects', 'address_groups', 'policies'] : arrayKeys;
                tableOrder.forEach(function(key) {
                    if (arrayKeys.indexOf(key) < 0 || key === 'path_hops') return;
                    var heading = document.createElement('p');
                    heading.className = 'summary-heading';
                    heading.textContent = (PANORAMA_TABLE_LABELS[key] || key.replace(/_/g, ' ').replace(/\b\w/g, function(c) { return c.toUpperCase(); }));
                    container.appendChild(heading);
                    var colOrder = PANORAMA_COLUMN_ORDER[key] || null;
                    var arr = data[key];
                    if (arr.length === 1 && isDeviceRackRow(arr[0])) {
                        var vTable = verticalTableFromRow(arr[0], DEVICE_RACK_KEYS);
                        if (vTable) { container.appendChild(vTable); }
                    } else {
                        var table = tableFromRows(data[key], colOrder);
                        if (table) { container.appendChild(table); wrapTableWithPaginationAndFilter(table); }
                    }
                });
                return true;
            }
            var scalarKeys = Object.keys(data).filter(function(k) { return data[k] != null && typeof data[k] !== 'object'; });
            if (scalarKeys.length > 0 && scalarKeys.length <= 20) {
                var st = tableFromRows([Object.fromEntries(scalarKeys.map(function(k) { return [k, data[k]]; }))]);
                if (st) { container.appendChild(st); wrapTableWithPaginationAndFilter(st); return true; }
            }
            return false;
        }

        function appendMessage(role, content) {
            var div = document.createElement('div');
            div.className = 'msg ' + role;
            if (content === undefined || content === null || (typeof content === 'string' && !content.trim())) {
                div.textContent = 'No response received.';
            } else if (typeof content === 'string') {
                div.textContent = content;
            } else if (typeof content === 'object') {
                // Handle yes/no answer first - display it prominently at the top
                if (content.yes_no_answer) {
                    var yesNoDiv = document.createElement('div');
                    yesNoDiv.className = 'yes-no-answer';
                    yesNoDiv.style.cssText = 'font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; padding: 0.75rem 1rem; border-radius: 8px; background: linear-gradient(135deg, rgba(137, 180, 250, 0.1) 0%, rgba(203, 166, 247, 0.1) 100%); border: 1px solid rgba(137, 180, 250, 0.3);';
                    yesNoDiv.textContent = content.yes_no_answer;
                    div.appendChild(yesNoDiv);
                }

                // Handle specific metric answers - display them prominently
                if (content.metric_answer) {
                    var metricDiv = document.createElement('div');
                    metricDiv.className = 'metric-answer';
                    metricDiv.style.cssText = 'font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; padding: 0.75rem 1rem; border-radius: 8px; background: linear-gradient(135deg, rgba(166, 227, 161, 0.1) 0%, rgba(137, 180, 250, 0.1) 100%); border: 1px solid rgba(166, 227, 161, 0.3);';
                    metricDiv.textContent = content.metric_answer;
                    div.appendChild(metricDiv);
                }

                // Handle Panorama direct answers - display them prominently
                if (content.direct_answer) {
                    var directDiv = document.createElement('div');
                    directDiv.className = 'direct-answer';
                    directDiv.style.cssText = 'font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; padding: 0.75rem 1rem; border-radius: 8px; background: linear-gradient(135deg, rgba(249, 226, 175, 0.1) 0%, rgba(166, 227, 161, 0.1) 100%); border: 1px solid rgba(249, 226, 175, 0.3);';
                    directDiv.textContent = content.direct_answer;
                    div.appendChild(directDiv);
                }

                if (content.error) {
                    // Don't treat clarification requests as errors (no red styling)
                    if (content.requires_site && content.sites && content.sites.length > 0) {
                        // This is a clarification question, not an error - display normally
                        var p = document.createElement('p');
                        p.textContent = content.error;
                        div.appendChild(p);
                        var prompt = document.createElement('p');
                        prompt.style.cssText = 'font-weight: 500; margin-top: 0.5rem; color: #89b4fa;';
                        prompt.textContent = 'Which site? ' + content.sites.join(', ') + '. Reply with the site name.';
                        div.appendChild(prompt);
                    } else {
                        // Actual error - show in red
                        div.classList.add('err');
                        div.textContent = content.error;
                    }
                } else if (content.path_hops && Array.isArray(content.path_hops) && content.path_hops.length > 0) {
                    renderPathWithIcons(div, content);
                    /* No extra tables after path visual - path is the main content */
                } else if (content.source && content.destination && !content.error && (!content.path_hops || content.path_hops.length === 0)) {
                    /* Path was calculated but hop details not available - show compact summary */
                    var pathWrap = document.createElement('div');
                    pathWrap.className = 'path-visual';
                    var pathLine = document.createElement('p');
                    pathLine.className = 'path-status';
                    pathLine.textContent = 'Path: ' + content.source + ' ‚Üí ' + content.destination;
                    pathWrap.appendChild(pathLine);
                    var statusDesc = content.path_status_description || content.path_status || content.statusDescription || '';
                    if (statusDesc) {
                        var statusP = document.createElement('p');
                        statusP.className = 'path-status';
                        statusP.style.marginTop = '0.5rem';
                        statusP.textContent = statusDesc;
                        if ((content.path_status || content.statusCode || '').toString().toLowerCase().indexOf('fail') !== -1) statusP.classList.add('failed');
                        pathWrap.appendChild(statusP);
                    }
                    if (content.message) {
                        var msgP = document.createElement('p');
                        msgP.style.marginTop = '0.5rem'; msgP.style.fontSize = '0.9rem'; msgP.style.color = '#a6adc8';
                        msgP.textContent = content.message;
                        pathWrap.appendChild(msgP);
                    } else if (content.note) {
                        var noteP = document.createElement('p');
                        noteP.style.marginTop = '0.5rem'; noteP.style.fontSize = '0.9rem'; noteP.style.color = '#a6adc8';
                        noteP.textContent = content.note;
                        pathWrap.appendChild(noteP);
                    }
                    if ((content.status === 'denied' || (content.reason && content.status === 'denied')) && (content.firewall_denied_by || content.policy_details)) {
                        if (content.firewall_denied_by) {
                            var fwP = document.createElement('p');
                            fwP.style.marginTop = '0.5rem'; fwP.style.color = '#f38ba8'; fwP.style.fontSize = '0.9rem';
                            fwP.textContent = 'Denied by firewall: ' + content.firewall_denied_by;
                            pathWrap.appendChild(fwP);
                        }
                        if (content.policy_details) {
                            var polP = document.createElement('p');
                            polP.style.marginTop = '0.25rem'; polP.style.color = '#a6adc8'; polP.style.fontSize = '0.9rem';
                            polP.textContent = 'Policy: ' + content.policy_details;
                            pathWrap.appendChild(polP);
                        }
                    }
                    div.appendChild(pathWrap);
                } else if (content.message || (content.ai_analysis && (content.ai_analysis.summary || content.ai_analysis.Summary))) {
                    var isDeviceRack = isDeviceRackRow(content);
                    var summaryText = content.message || (content.ai_analysis && (content.ai_analysis.summary || content.ai_analysis.Summary));
                    var sumStr = summaryText && (typeof summaryText === 'string' ? summaryText : JSON.stringify(summaryText));
                    var hasStructuredTables = (Array.isArray(content.address_objects) && content.address_objects.length > 0) ||
                        (Array.isArray(content.address_groups) && content.address_groups.length > 0) ||
                        (Array.isArray(content.policies) && content.policies.length > 0);
                    var looksLikeMarkdownTable = sumStr && (/^\s*\|[\s\-:]+\|/.test(sumStr) || /\*\*Table\s*\d/i.test(sumStr) || sumStr.indexOf('| ---') !== -1);
                    var showSummary = sumStr && (!hasStructuredTables || (!looksLikeMarkdownTable && sumStr.length <= 500));
                    if (isDeviceRack && showSummary) {
                        tryAppendObjectAsTables(div, content);
                        var gap1 = document.createElement('p');
                        gap1.style.marginTop = '1rem'; gap1.style.marginBottom = '0.5rem'; gap1.innerHTML = '&nbsp;';
                        div.appendChild(gap1);
                        var sp = document.createElement('p');
                        sp.textContent = sumStr;
                        sp.style.marginBottom = '0.75rem';
                        div.appendChild(sp);
                    } else {
                        if (content.message) {
                            var mp = document.createElement('p');
                            mp.textContent = content.message;
                            mp.style.marginBottom = '0.75rem';
                            div.appendChild(mp);
                        }
                        if (content.ai_analysis && (content.ai_analysis.summary || content.ai_analysis.Summary) && showSummary) {
                            var sp = document.createElement('p');
                            sp.textContent = sumStr;
                            sp.style.marginBottom = '0.75rem';
                            div.appendChild(sp);
                        }
                        tryAppendObjectAsTables(div, content);
                    }
                } else if (tryAppendObjectAsTables(div, content)) {
                } else {
                    var pre = document.createElement('pre');
                    pre.textContent = JSON.stringify(content, null, 2);
                    div.appendChild(pre);
                }
            } else {
                div.textContent = String(content);
            }
            messagesEl.appendChild(div);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        async function send(e) {
            e.preventDefault();
            var text = inputEl.value.trim();
            if (!text) return false;
            inputEl.value = '';
            sendBtn.disabled = true;
            appendMessage('user', text);
            conversationHistory.push({ role: 'user', content: text });
            var statusEl = document.createElement('div');
            statusEl.className = 'msg status-msg';
            statusEl.textContent = 'Processing...';
            messagesEl.appendChild(statusEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;
            try {
                var res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text, conversation_history: conversationHistory.slice(-20) })
                });
                statusEl.remove();
                var data = await res.json().catch(function() { return {}; });
                var assistantContent = !res.ok ? (data.detail || data.message || 'Request failed') : (data.content ?? data.message ?? 'No response');
                if (assistantContent === undefined || assistantContent === null) assistantContent = 'No response received.';
                appendMessage('assistant', assistantContent);
                var forHistory = typeof assistantContent === 'string' ? assistantContent : JSON.stringify(assistantContent);
                conversationHistory.push({ role: 'assistant', content: forHistory });
            } catch (err) {
                statusEl.remove();
                var errMsg = err && err.message ? err.message : String(err);
                if (errMsg.indexOf('fetch') !== -1) errMsg = 'Request failed. Check that the server is running and the request did not time out.';
                appendMessage('assistant', 'Error: ' + errMsg);
                conversationHistory.push({ role: 'assistant', content: 'Error: ' + errMsg });
            }
            sendBtn.disabled = false;
            return false;
        }
    </script>
</body>
</html>
